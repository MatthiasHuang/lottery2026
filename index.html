<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â™¥ ãŠ£ (ç´”) æ¿€çƒˆäº¤æµç¾¤çµ„æº«è…¥å°¾ç‰™ ãŠ£ â™¥ </title>
    <style>
        /* ğŸ¨ é¡è‰²èˆ‡å­—é«”è¨­å®š (å…¸é›…æš—è‰²åº•äº®å­—) */
        :root {
            --primary: #b3884d; /* æŸ”å’Œé‡‘è‰²/é’éŠ…è‰² (Accent) */
            --secondary: #f0f0f0; /* æŸ”å’Œç™½è‰² (Main text accent) */
            --bg-gradient: linear-gradient(135deg, #0a0a0a 0%, #171717 100%); /* æ¥µæ·±æœ¨ç‚­è‰² */
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px; /* å¢åŠ æœ€å¤§å¯¬åº¦ */
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 50px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 3rem; /* å­—é«”åŠ å¤§ */
            margin: 0;
            letter-spacing: 3px;
            /* æ¨™é¡Œæ¼¸è®Šæ•ˆæœ */
            background: -webkit-linear-gradient(top, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .header p {
            color: #a1a1aa;
            margin-top: 10px;
            font-size: 1.1rem;
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border: 1px solid var(--glass-border);
            border-radius: 30px; /* åœ“è§’åŠ å¤§ */
            padding: 40px; /* å…§é‚Šè·åŠ å¤§ */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .stage {
            min-height: 380px; /* èˆå°é«˜åº¦å¢åŠ  */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .label-text {
            color: var(--primary);
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 5px;
            margin-bottom: 20px;
            font-weight: 700;
        }

        /* ğŸ† æ ¸å¿ƒå­—é«”åŠ å¤§ ğŸ† */
        .winner-name {
            font-size: 5rem; 
            font-weight: 900;
            margin: 15px 0;
            min-height: 1.2em;
            color: var(--secondary);
            text-shadow: 0 0 50px rgba(179, 136, 77, 0.8); /* é‡‘è‰²å…‰æšˆ */
            line-height: 1;
            transition: all 0.1s; /* for animation */
        }

        .gift-box {
            margin-top: 30px;
            padding: 30px;
            background: rgba(0,0,0,0.4);
            border-radius: 20px;
            width: 90%;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--primary);
        }

        .gift-box.show {
            transform: scale(1);
            opacity: 1;
        }

        .gift-name {
            font-size: 2.5rem; /* å­—é«”åŠ å¤§ */
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .provider-name {
            font-size: 1.3rem;
            color: #d4d4d8;
            font-style: italic;
        }

        .btn-draw {
            background: linear-gradient(135deg, #606060 0%, #303030 100%); /* æ²‰ç©©çš„é‡‘å±¬ç° */
            border: 3px solid var(--primary);
            color: var(--primary);
            padding: 22px 50px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.7rem; /* å­—é«”åŠ å¤§ */
            box-shadow: 0 4px 25px rgba(179, 136, 77, 0.4);
            transition: all 0.3s ease;
            margin-top: 30px;
            width: 100%;
        }

        .btn-draw:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(179, 136, 77, 0.8);
            filter: brightness(1.2);
            color: var(--secondary);
        }

        .btn-draw:disabled {
            background: #27272a;
            border-color: #52525b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            color: #a1a1aa;
        }

        /* ç´€éŒ„å€æ¨£å¼ */
        .history-list {
            gap: 15px;
            max-height: 550px;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 18px 25px;
            border-radius: 15px;
            border-left: 5px solid var(--primary);
        }
        
        .history-item:first-child {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: var(--primary);
            border: 1px solid var(--primary);
            border-left: 5px solid var(--primary);
        }

        .h-winner {
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--secondary);
        }
        
        .h-gift {
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 600;
        }

        .h-provider {
            font-size: 0.9rem;
            color: #a1a1aa;
        }

        /* ğŸ“± æ‰‹æ©Ÿå‹å–„å„ªåŒ– (Mobile Responsiveness) */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { margin-top: 20px; gap: 20px; }
            .card { padding: 25px; border-radius: 20px; }

            .header h1 { font-size: 2.2rem; }
            .header p { font-size: 0.9rem; }

            .stage { min-height: 300px; }
            
            /* æ ¸å¿ƒå­—é«”ç¸®å°ä»¥é˜²æº¢å‡º */
            .winner-name { font-size: 3rem; margin: 10px 0; }
            .gift-name { font-size: 1.8rem; }
            .provider-name { font-size: 1rem; }

            .btn-draw { 
                font-size: 1.3rem; 
                padding: 18px 30px;
            }

            .history-item {
                padding: 15px;
                grid-template-columns: 1fr; /* åœ¨æ‰‹æ©Ÿä¸Šå †ç–Š */
            }
            .h-gift-info {
                text-align: left;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>âœ¨ æ­²æœ«äº¤æ›ç¦®ç‰©æ´¾å° âœ¨</h1>
        <p>è€å°‘å’¸å®œ | çµ•ç„¡é»‘ç®± | ä¿è­‰å…¬å¹³</p>
    </div>

    <div id="errorDisplay" class="error-msg"></div>

    <div id="gameCard" class="card">
        <div class="stage">
            <div class="label-text">WHO IS NEXT?</div>
            <div id="winnerDisplay" class="winner-name">æº–å‚™é–‹å§‹</div>
            
            <div id="giftBox" class="gift-box">
                <div class="label-text" style="font-size:0.8rem; letter-spacing:3px;">THE PRIZE IS</div>
                <div id="giftNameDisplay" class="gift-name">???</div>
                <div id="providerDisplay" class="provider-name">???</div>
            </div>
        </div>

        <button id="drawBtn" class="btn-draw" onclick="drawNext()">ğŸ² å•Ÿå‹•æŠ½ç</button>
        
        <div class="stats">
            ç¸½åƒèˆ‡: <span id="totalPeople">0</span> | 
            å¾…æ­æ›‰: <span id="remainingCount">0</span>
        </div>
    </div>

    <div class="card history-section">
        <div class="history-title">
            <span>ğŸ† ç²çå¿«è¨Š (æœ€æ–°åœ¨æœ€ä¸Š)</span>
            <span style="font-size:0.9rem; opacity:0.6">History</span>
        </div>
        <div id="historyList" class="history-list">
            <div id="emptyMsg" style="text-align:center; color:rgba(255,255,255,0.2); padding:30px;">
                ç­‰å¾…ç¬¬ä¸€ä½å¹¸é‹å…’...
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
//    ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹åœ¨æ­¤ä¿®æ”¹åå–® ğŸ‘‡ğŸ‘‡ğŸ‘‡
// ==========================================

// æ‚¨çš„åå–®
const participantsData = [
    { name: 'å°å·¦', gift: 'ç¦®ç‰© A' },
    { name: 'å¤§éš»', gift: 'ç¦®ç‰© B' }, // çµ‚æ¥µå¤§çæä¾›è€…
    { name: 'ç‡™å¤§', gift: 'ç¦®ç‰© C' },
    { name: 'Jojo', gift: 'ç¦®ç‰© D' },
    { name: 'Z å¤§', gift: 'ç¦®ç‰© E' },
    { name: 'å°æŸ¯', gift: 'ç¦®ç‰© F' },
    { name: 'æµ·å“¥', gift: 'ç¦®ç‰© G' },
    { name: 'æ²æ¯›', gift: 'ç¦®ç‰© H' },
    { name: 'Ian', gift: 'ç¦®ç‰© I' },
];

// ==========================================
//    ğŸ‘†ğŸ‘†ğŸ‘† ä¿®æ”¹çµæŸï¼Œä»¥ä¸‹å‹¿å‹• ğŸ‘†ğŸ‘†ğŸ‘†
// ==========================================

let drawPool = [];
let currentIndex = 0;
let isAnimating = false;
let isUltimateStage = false; // æ˜¯å¦é€²å…¥çµ‚æ¥µå¤§çéšæ®µ

window.onload = function() {
    const giftCount = participantsData.filter(p => p.gift).length;
    document.getElementById('totalPeople').innerText = participantsData.length;
    
    if (participantsData.length < 2) {
        showError("äººæ•¸ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ 2 äººæ‰èƒ½é€²è¡Œäº¤æ›ï¼");
        return;
    }
    if (giftCount === 0) {
        showError("æ²’æœ‰äººæº–å‚™ç¦®ç‰©ï¼Œç„¡æ³•é€²è¡ŒæŠ½çï¼");
        return;
    }

    const success = calculateRobustMatches();
    if (success) {
        document.getElementById('remainingCount').innerText = drawPool.length;
    } else {
        showError("é…å°é‹ç®—å¤±æ•—ï¼è«‹æª¢æŸ¥é…ç½®æ˜¯å¦ç„¡æ³•æ»¿è¶³ã€Œä¸æŠ½åˆ°è‡ªå·±ã€çš„æ¢ä»¶ã€‚");
    }
};

function showError(msg) {
    const err = document.getElementById('errorDisplay');
    err.style.display = 'block';
    err.innerText = "âš ï¸ " + msg;
    document.getElementById('drawBtn').disabled = true;
    document.getElementById('drawBtn').style.opacity = 0.5;
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        let randomVal = (window.crypto && window.crypto.getRandomValues) 
            ? window.crypto.getRandomValues(new Uint32Array(1))[0] / (0xffffffff + 1) 
            : Math.random();
        const j = Math.floor(randomVal * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function calculateRobustMatches() {
    let providers = participantsData.filter(p => p.gift).map(p => p.name);
    let receivers = participantsData.map(p => p.name);
    let isValid = false;
    let attempt = 0;
    let finalMatches = [];

    while (!isValid && attempt < 5000) {
        attempt++;
        shuffle(receivers);
        shuffle(providers); 
        let tempMatches = [];
        let currentRoundValid = true;
        
        for (let i = 0; i < providers.length; i++) {
            if (receivers[i] === providers[i]) {
                currentRoundValid = false;
                break;  
            }
            tempMatches.push({
                winner: receivers[i],
                prize: `æ­å–œæŠ½åˆ° ${providers[i]} çš„ç¦®ç‰©`,
                provider: providers[i]
            });
        }
        if (currentRoundValid) {
            isValid = true;
            finalMatches = tempMatches;
        }
    }

    if (isValid) {
        shuffle(finalMatches); 
        drawPool = finalMatches;
        return true;
    }
    return false;
}

function drawNext() {
    if (isAnimating) return;
    
    // æª¢æŸ¥æ˜¯å¦é€²å…¥çµ‚æ¥µå¤§çéšæ®µ
    if (currentIndex >= drawPool.length && !isUltimateStage) {
        startUltimateDraw();
        return;
    }

    isAnimating = true;
    const btn = document.getElementById('drawBtn');
    const winnerEl = document.getElementById('winnerDisplay');
    const giftBoxEl = document.getElementById('giftBox');
    
    btn.disabled = true;
    giftBoxEl.classList.remove('show');
    
    const countLimit = 35;
    let count = 0;
    
    // å¦‚æœæ˜¯çµ‚æ¥µå¤§çï¼Œç›®æ¨™å¾ã€Œéå¤§éš»ã€åå–®ä¸­é¸
    let targetResult;
    let rollNames = participantsData.map(p => p.name);

    if (isUltimateStage) {
        const candidates = participantsData.filter(p => p.name !== 'å¤§éš»');
        const luckyOne = candidates[Math.floor(Math.random() * candidates.length)];
        targetResult = {
            winner: luckyOne.name,
            prize: "âœ¨ çµ‚æ¥µå¤§ç âœ¨",
            provider: "å¤§éš» (ç‰¹åˆ¥è´ŠåŠ©)"
        };
    } else {
        targetResult = drawPool[currentIndex];
    }

    const interval = setInterval(() => {
        const randomName = rollNames[Math.floor(Math.random() * rollNames.length)];
        winnerEl.innerText = randomName;
        winnerEl.style.transform = `scale(${0.9 + Math.random() * 0.3})`;
        
        count++;
        if (count >= countLimit) {
            clearInterval(interval);
            winnerEl.style.transform = "scale(1)";
            revealWinner(targetResult);
        }
    }, 60);
}

function revealWinner(result) {
    const winnerEl = document.getElementById('winnerDisplay');
    const giftBoxEl = document.getElementById('giftBox');
    const giftNameEl = document.getElementById('giftNameDisplay');
    const providerEl = document.getElementById('providerDisplay');
    const btn = document.getElementById('drawBtn');

    winnerEl.innerText = result.winner;
    
    // çµ‚æ¥µå¤§çç‰¹æ•ˆ
    if (isUltimateStage) {
        winnerEl.style.color = "#fff";
        winnerEl.style.textShadow = "0 0 20px #fff, 0 0 40px #b3884d, 0 0 60px #b3884d";
        document.body.style.transition = "0.3s";
        document.body.style.boxShadow = "inset 0 0 100px #b3884d";
        
        setTimeout(() => {
            giftNameEl.innerHTML = `<span style="color:#fff">â­ XGPU ä¸€å¹´ä»½ â­</span><br>${result.prize}`;
            providerEl.innerText = `æ­å–œï¼å…¨å ´æœ€å°Šæ¦®ï¼ç¥é‹é–‹å±€ï¼`;
            giftBoxEl.classList.add('show');
            addHistory(result, true);
            
            btn.innerText = "ğŸŠ æŠ½çåœ“æ»¿çµæŸ ğŸŠ";
            btn.disabled = true;
            isAnimating = false;
        }, 1000);
        
    } else {
        // ä¸€èˆ¬ç²ç
        setTimeout(() => {
            giftNameEl.innerText = result.prize;
            providerEl.innerText = `ğŸ‰ å¦–å£½è®š`;
            giftBoxEl.classList.add('show');
            addHistory(result, false);
            
            currentIndex++;
            document.getElementById('remainingCount').innerText = drawPool.length - currentIndex;
            isAnimating = false;

            if (currentIndex >= drawPool.length) {
                btn.innerText = "ğŸ’¥ æ­æ›‰æœ€å¾Œçš„ï¼šçµ‚æ¥µå¤§ç ğŸ’¥";
                btn.style.background = "linear-gradient(135deg, #b3884d 0%, #5d4037 100%)";
                btn.style.color = "#fff";
                btn.disabled = false;
            } else {
                btn.disabled = false;
            }
        }, 800);
    }
}

function startUltimateDraw() {
    isUltimateStage = true;
    const winnerEl = document.getElementById('winnerDisplay');
    const giftBoxEl = document.getElementById('giftBox');
    
    winnerEl.innerText = "æº–å‚™æ­æ›‰...";
    giftBoxEl.classList.remove('show');
    drawNext();
}

function addHistory(result, isUltimate) {
    const list = document.getElementById('historyList');
    const emptyMsg = document.getElementById('emptyMsg');
    if (emptyMsg) emptyMsg.remove();

    const div = document.createElement('div');
    div.className = 'history-item';
    if (isUltimate) {
        div.style.border = "2px solid #b3884d";
        div.style.background = "rgba(179, 136, 77, 0.2)";
    }
    div.innerHTML = `
        <div class="h-winner">${isUltimate ? 'ğŸŒŸ' : 'ğŸ‘‘'} ${result.winner}</div>
        <div class="h-gift-info">
            <div class="h-gift">${result.prize}</div>
            <span class="h-provider">from ${result.provider}</span>
        </div>
    `;
    list.prepend(div);
}
</script>
</body>
</html>
